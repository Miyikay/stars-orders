<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stars Orders â€“ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #ff5a1f;
      --primary-dark: #e04b13;
      --bg: #f7f7f7;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --text-main: #222222;
      --text-muted: #666666;
      --status-received: #ffe6da;
      --status-preparing: #fff6c2;
      --status-completed: #d4f5dd;
      --status-cancelled: #ffe4e4;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    h1 {
      margin: 0 0 8px 0;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }

    .last-refresh {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    label {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    select, input[type="password"] {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      font-family: inherit;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: #fff;
    }

    button.secondary {
      background: #f0f0f0;
      color: var(--text-main);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    .card {
      background: var(--card-bg);
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 12px;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      background: #fafafa;
    }

    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #f0f0f0;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--text-muted);
      white-space: nowrap;
    }

    tbody tr:nth-child(even) {
      background-color: #fcfcfc;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .status-received {
      background: var(--status-received);
      color: #8b3a18;
    }

    .status-preparing {
      background: var(--status-preparing);
      color: #8b6c18;
    }

    .status-completed {
      background: var(--status-completed);
      color: #166534;
    }

    .status-cancelled {
      background: var(--status-cancelled);
      color: #b91c1c;
    }

    .status-select {
      margin-right: 6px;
    }

    .small {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    @media (max-width: 768px) {
      h1 {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>

  <h1>Stars Orders â€“ Admin</h1>
  <div class="subtitle">
    Enter your PIN to view and manage all incoming orders.
  </div>

  <!-- PIN + controls -->
  <div class="top-bar">
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <label for="adminPin">Admin PIN:</label>
      <input type="password" id="adminPin" placeholder="Enter PIN">
      <button id="loginBtn">Login</button>
    </div>

    <div style="display:flex; gap:8px; align-items:center;">
      <label for="filterStatus">Filter status:</label>
      <select id="filterStatus">
        <option value="All">All</option>
        <option value="Received">Received</option>
        <option value="Preparing">Preparing</option>
        <option value="Completed">Completed</option>
        <option value="Cancelled">Cancelled</option>
      </select>
      <button id="refreshBtn" class="secondary">Refresh</button>
    </div>
  </div>

  <div class="last-refresh">
    Last refresh: <span id="lastRefresh">â€“</span>
  </div>

  <div class="card">
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Time</th>
          <th>Location</th>
          <th>Customer</th>
          <th>Phone</th>
          <th>Items</th>
          <th>Total (â‚¦)</th>
          <th>Notes</th>
          <th>Status</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody id="ordersBody">
        <tr><td colspan="10">Please enter PIN and click Login.</td></tr>
      </tbody>
    </table>
  </div>

  <div id="adminMessage" class="small" style="margin-top:8px;"></div>

  <script>
    // ðŸ”— SAME web app URL as your order page
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykcL-56UBxebRUpFk_01x3vstSjmQ12fwPWZEvSmGEWZlDiP_pYTEMczmDKRXDGdHaXg/exec";

    const statusOptions = ["Received", "Preparing", "Completed", "Cancelled"];

    const ordersBody    = document.getElementById("ordersBody");
    const filterStatus  = document.getElementById("filterStatus");
    const refreshBtn    = document.getElementById("refreshBtn");
    const lastRefreshEl = document.getElementById("lastRefresh");
    const adminMessage  = document.getElementById("adminMessage");
    const adminPinInput = document.getElementById("adminPin");
    const loginBtn      = document.getElementById("loginBtn");

    let currentPin = "";

    function setMessage(text, isError = false) {
      adminMessage.textContent = text || "";
      adminMessage.style.color = isError ? "red" : "#555";
    }

    function statusClass(status) {
      const s = (status || "").toLowerCase();
      if (s === "preparing") return "status-preparing";
      if (s === "completed") return "status-completed";
      if (s === "cancelled") return "status-cancelled";
      return "status-received";
    }

    async function loadOrders() {
      if (!currentPin) {
        setMessage("Enter your admin PIN and click Login.", true);
        ordersBody.innerHTML =
          "<tr><td colspan='10'>PIN required.</td></tr>";
        return;
      }

      const filter = filterStatus.value || "All";

      ordersBody.innerHTML =
        "<tr><td colspan='10'>Loading orders...</td></tr>";
      setMessage("");

      try {
        const resp = await fetch(
          SCRIPT_URL +
          "?mode=orders&status=" + encodeURIComponent(filter) +
          "&pin=" + encodeURIComponent(currentPin)
        );
        const data = await resp.json();

        if (!data.success) {
          ordersBody.innerHTML =
            "<tr><td colspan='10' style='color:red;'>Unauthorized or error.</td></tr>";
          setMessage(data.error || "Invalid PIN or error.", true);
          return;
        }

        const orders = data.orders || [];
        renderOrders(orders);

        const ts = data.lastRefresh
          ? new Date(data.lastRefresh)
          : new Date();
        lastRefreshEl.textContent = ts.toLocaleString();

        if (orders.length === 0) {
          setMessage("No orders found for this filter.");
        }

      } catch (err) {
        console.error(err);
        ordersBody.innerHTML =
          "<tr><td colspan='10' style='color:red;'>Error loading orders.</td></tr>";
        setMessage("Error loading orders. Check script URL / deployment.", true);
      }
    }

    function renderOrders(orders) {
      ordersBody.innerHTML = "";

      if (!orders.length) {
        ordersBody.innerHTML =
          "<tr><td colspan='10'>No orders yet.</td></tr>";
        return;
      }

      orders.forEach(order => {
        const tr = document.createElement("tr");

        function td(text) {
          const cell = document.createElement("td");
          cell.textContent = text || "";
          return cell;
        }

        tr.appendChild(td(order.orderId || ""));
        tr.appendChild(td(order.time || ""));
        tr.appendChild(td(order.location || ""));
        tr.appendChild(td(order.customerName || ""));
        tr.appendChild(td(order.phone || ""));
        tr.appendChild(td(order.items || ""));
        tr.appendChild(td(order.total || 0));
        tr.appendChild(td(order.notes || ""));

        // Status pill
        const statusTd = document.createElement("td");
        const pill = document.createElement("span");
        pill.className = "status-pill " + statusClass(order.status);
        pill.textContent = order.status || "Received";
        statusTd.appendChild(pill);
        tr.appendChild(statusTd);

        // Update controls
        const updateTd = document.createElement("td");
        const select = document.createElement("select");
        select.className = "status-select";

        statusOptions.forEach(opt => {
          const o = document.createElement("option");
          o.value = opt;
          o.textContent = opt;
          if ((order.status || "Received") === opt) {
            o.selected = true;
          }
          select.appendChild(o);
        });

        const saveBtn = document.createElement("button");
        saveBtn.textContent = "Save";
        saveBtn.addEventListener("click", () => {
          saveStatus(order.rowIndex, select.value, saveBtn, pill);
        });

        updateTd.appendChild(select);
        updateTd.appendChild(saveBtn);
        tr.appendChild(updateTd);

        ordersBody.appendChild(tr);
      });
    }

    async function saveStatus(rowIndex, newStatus, button, pill) {
      if (!rowIndex || !currentPin) return;

      button.disabled = true;
      button.textContent = "Saving...";
      setMessage("");

      try {
        await fetch(SCRIPT_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            action: "updateStatus",
            rowIndex: rowIndex,
            status: newStatus,
            pin: currentPin
          })
        });

        pill.textContent = newStatus;
        pill.className   = "status-pill " + statusClass(newStatus);
        setMessage("Status updated.");

      } catch (err) {
        console.error(err);
        setMessage("Error updating status. Please try again.", true);
      } finally {
        button.disabled = false;
        button.textContent = "Save";
      }
    }

    // When user clicks Login, store PIN in memory and load orders
    loginBtn.addEventListener("click", () => {
      const pin = adminPinInput.value.trim();
      if (!pin) {
        setMessage("Please enter your admin PIN.", true);
        return;
      }
      currentPin = pin;
      setMessage("");
      loadOrders();
    });

    // Change filter or refresh reuses same PIN
    filterStatus.addEventListener("change", loadOrders);
    refreshBtn.addEventListener("click", loadOrders);
  </script>
</body>
</html>
