<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stars Orders ‚Äì Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #ff5a1f;
      --primary-soft: #ffe6d5;
      --bg: #f5f5f8;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --text-main: #222;
      --text-muted: #666;
      --badge-received: #ffe6d5;
      --badge-preparing: #fff3cd;
      --badge-completed: #d1f7d6;
      --badge-cancelled: #f8d7da;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    h1 {
      margin: 0 0 4px 0;
      font-size: 1.5rem;
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .pill-live {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
      font-size: 0.8rem;
      font-weight: 600;
    }

    .pill-live span:first-child {
      font-size: 0.7rem;
    }

    .controls-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    select, input {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
      font-family: inherit;
    }

    button {
      font-family: inherit;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--primary);
      color: #fff;
    }

    .btn-secondary {
      background: #f1f1f1;
      color: var(--text-main);
    }

    .meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .date-section {
      background: var(--card-bg);
      border-radius: 14px;
      border: 1px solid var(--border);
      margin-bottom: 14px;
      overflow: hidden;
    }

    .date-header {
      padding: 8px 12px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 8px;
      background: #fafafa;
    }

    .date-title {
      font-weight: 600;
      font-size: 0.95rem;
    }

    .date-meta {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: top;
      text-align: left;
    }

    th {
      background: #fff;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .badge {
      display: inline-flex;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge-received { background: var(--badge-received); }
    .badge-preparing { background: var(--badge-preparing); }
    .badge-completed { background: var(--badge-completed); }
    .badge-cancelled { background: var(--badge-cancelled); }

    .status-select {
      font-size: 0.75rem;
    }

    .btn-save {
      padding: 4px 10px;
      font-size: 0.75rem;
    }

    .orders-wrapper {
      max-height: calc(100vh - 140px);
      overflow: auto;
      padding-right: 4px;
    }

    @media (max-width: 900px) {
      th:nth-child(4),
      td:nth-child(4) {
        display: none; /* hide phone on small screens */
      }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div>
    <div style="font-size:0.8rem; letter-spacing:0.08em; text-transform:uppercase; color:var(--primary); font-weight:700;">
      Stars Orders
    </div>
    <h1>Admin</h1>
    <div class="subtitle">View and manage all incoming orders from your Google Sheet.</div>
  </div>
  <div class="pill-live">
    <span>‚óè</span>
    <span>Live dashboard</span>
  </div>
</div>

<div class="controls-row">
  <div>
    <span class="meta">Filter by status:</span>
    <select id="statusFilter">
      <option value="All">All</option>
      <option value="Received">Received</option>
      <option value="Preparing">Preparing</option>
      <option value="Completed">Completed</option>
      <option value="Cancelled">Cancelled</option>
    </select>
  </div>
  <button class="btn" id="refreshBtn">Refresh</button>
  <span id="metaInfo" class="meta"></span>
</div>

<div class="orders-wrapper" id="ordersWrapper">
  <!-- date sections injected here -->
</div>

<script>
  // üîó CHANGE THIS to your deployed Apps Script URL
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzS4r5yE1x76Na6wpwolo_g96g9SeJ64Lx6LlZyENpiZWuZ_HBnRu1apN75cAmjvjjv9g/exec";

  let ADMIN_PIN = localStorage.getItem("stars_admin_pin") || "";

  if (!ADMIN_PIN) {
    ADMIN_PIN = prompt("Enter admin PIN:");
    if (ADMIN_PIN) {
      localStorage.setItem("stars_admin_pin", ADMIN_PIN);
    }
  }

  const statusFilterEl = document.getElementById("statusFilter");
  const refreshBtn = document.getElementById("refreshBtn");
  const metaInfoEl = document.getElementById("metaInfo");
  const ordersWrapper = document.getElementById("ordersWrapper");

  refreshBtn.addEventListener("click", loadOrders);
  statusFilterEl.addEventListener("change", loadOrders);

  function getStatusBadgeClass(status) {
    const s = String(status || "").toLowerCase();
    if (s === "preparing") return "badge-preparing";
    if (s === "completed") return "badge-completed";
    if (s === "cancelled") return "badge-cancelled";
    return "badge-received";
  }

  function getStatusOptionsHtml(current) {
    const options = ["Received", "Preparing", "Completed", "Cancelled"];
    return options.map(s =>
      `<option value="${s}" ${s === current ? "selected" : ""}>${s}</option>`
    ).join("");
  }

  function groupByDate(orders) {
    const map = new Map();
    orders.forEach(o => {
      const parts = String(o.time || "").split(" ");
      const dateOnly = parts[0] || "Unknown date";
      if (!map.has(dateOnly)) map.set(dateOnly, []);
      map.get(dateOnly).push(o);
    });
    return map;
  }

  function renderOrders(orders) {
    ordersWrapper.innerHTML = "";
    if (!orders || orders.length === 0) {
      ordersWrapper.innerHTML = "<p class='meta'>No orders found.</p>";
      return;
    }

    const grouped = groupByDate(orders);

    [...grouped.entries()].sort((a, b) => {
      // newest date first
      return new Date(b[0]) - new Date(a[0]);
    }).forEach(([date, list]) => {
      const totalForDay = list.reduce((sum, o) => sum + (o.total || 0), 0);

      const section = document.createElement("section");
      section.className = "date-section";

      const header = document.createElement("div");
      header.className = "date-header";
      header.innerHTML = `
        <div class="date-title">${date}</div>
        <div class="date-meta">
          ${list.length} order${list.length > 1 ? "s" : ""} ‚Ä¢ Total ‚Ç¶${totalForDay}
        </div>
      `;
      section.appendChild(header);

      const table = document.createElement("table");
      table.innerHTML = `
        <thead>
          <tr>
            <th>Order ID</th>
            <th>Time</th>
            <th>Location</th>
            <th>Customer / Phone</th>
            <th>Items</th>
            <th>Total (‚Ç¶)</th>
            <th>Notes</th>
            <th>Status</th>
            <th>Update</th>
          </tr>
        </thead>
        <tbody>
          ${list.map(o => `
            <tr data-row="${o.rowIndex}">
              <td>${o.orderId || ""}</td>
              <td>${o.time || ""}</td>
              <td>${o.location || ""}</td>
              <td>
                <strong>${o.customerName || ""}</strong><br>
                <span class="meta">${o.phone || ""}</span>
              </td>
              <td>${o.items || ""}</td>
              <td>${o.total || 0}</td>
              <td>${o.notes || ""}</td>
              <td>
                <span class="badge ${getStatusBadgeClass(o.status)}">
                  ${o.status || "Received"}
                </span>
              </td>
              <td>
                <select class="status-select">
                  ${getStatusOptionsHtml(o.status)}
                </select>
                <button class="btn btn-save">Save</button>
              </td>
            </tr>
          `).join("")}
        </tbody>
      `;
      section.appendChild(table);
      ordersWrapper.appendChild(section);
    });

    // wire up Save buttons
    ordersWrapper.querySelectorAll(".btn-save").forEach(btn => {
      btn.addEventListener("click", async () => {
        const row = btn.closest("tr");
        const rowIndex = row.getAttribute("data-row");
        const select = row.querySelector("select.status-select");
        const newStatus = select.value;
        await updateStatus(rowIndex, newStatus);
      });
    });
  }

  async function loadOrders() {
    if (!ADMIN_PIN) {
      alert("No admin PIN set.");
      return;
    }
    const filter = statusFilterEl.value || "All";
    metaInfoEl.textContent = "Loading orders‚Ä¶";

    try {
      const url = `${SCRIPT_URL}?mode=orders&pin=${encodeURIComponent(
        ADMIN_PIN
      )}&status=${encodeURIComponent(filter)}`;

      const resp = await fetch(url);
      const data = await resp.json();

      if (!data.success) {
        throw new Error(data.error || "Unknown error");
      }

      renderOrders(data.orders || []);
      const when = new Date(data.lastRefresh || Date.now());
      metaInfoEl.textContent =
        `Last refresh: ${when.toLocaleString()} ‚Ä¢ Loaded ${data.orders.length} orders.`;
    } catch (err) {
      console.error(err);
      metaInfoEl.textContent = "Error loading orders. Check PIN or script URL.";
    }
  }

  async function updateStatus(rowIndex, status) {
    try {
      const payload = {
        action: "updateStatus",
        rowIndex: Number(rowIndex),
        status: status,
        pin: ADMIN_PIN
      };

      const resp = await fetch(SCRIPT_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await resp.json();
      if (!data.success) {
        throw new Error(data.error || "Unknown error");
      }

      await loadOrders();
    } catch (err) {
      console.error(err);
      alert("Error updating status. Check PIN / script logs.");
    }
  }

  // initial load
  loadOrders();
</script>

</body>
</html>
