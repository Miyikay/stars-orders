<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stars Orders â€“ Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #ff5a1f;
      --primary-soft: #ffe6da;
      --primary-dark: #e04b13;
      --bg: #f7f7f7;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --text-main: #222222;
      --text-muted: #666666;
      --danger: #e02424;
      --success: #0f9d58;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    h1 {
      margin: 0 0 4px 0;
      font-size: 1.6rem;
    }

    .subtitle {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }

    .brand {
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--primary);
      font-size: 0.8rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: var(--primary-soft);
      color: var(--primary-dark);
    }

    .pill-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #0f9d58;
    }

    .card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--border);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    th, td {
      padding: 8px 6px;
      border-bottom: 1px solid #f0f0f0;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-muted);
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    tr:nth-child(even) td {
      background: #fcfcfc;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: #f3f3f3;
      color: var(--text-main);
    }

    .chip.received {
      background: #fff3e0;
      color: #e65100;
    }

    .chip.preparing {
      background: #e3f2fd;
      color: #0d47a1;
    }

    .chip.completed {
      background: #e8f5e9;
      color: #1b5e20;
    }

    .chip.cancelled {
      background: #ffebee;
      color: #b71c1c;
    }

    select {
      padding: 4px 6px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      background: var(--primary);
      color: white;
      white-space: nowrap;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .btn-small {
      padding: 4px 10px;
      font-size: 0.78rem;
    }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.8rem;
      margin-bottom: 8px;
      color: var(--text-muted);
    }

    .toolbar select {
      font-size: 0.8rem;
    }

    .meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .status-message {
      font-size: 0.8rem;
      margin-top: 4px;
      min-height: 18px;
    }

    .status-message.ok {
      color: var(--success);
    }

    .status-message.err {
      color: var(--danger);
    }

    @media (max-width: 900px) {
      table {
        font-size: 0.8rem;
      }
      th, td {
        padding: 6px 4px;
      }
    }
  </style>
</head>
<body>

<div class="top-bar">
  <div>
    <div class="brand">STARS ORDERS</div>
    <h1>Admin</h1>
    <div class="subtitle">View and manage all incoming orders from your Google Sheet.</div>
  </div>
  <div class="pill">
    <span class="pill-dot"></span>
    <span>Live dashboard</span>
  </div>
</div>

<div class="meta">
  Last refresh: <span id="lastRefresh">â€“</span>
</div>

<div class="toolbar card" style="margin-bottom:10px;">
  <div>
    Filter by status:
    <select id="statusFilter">
      <option value="All">All</option>
      <option value="Received">Received</option>
      <option value="Preparing">Preparing</option>
      <option value="Completed">Completed</option>
      <option value="Cancelled">Cancelled</option>
    </select>
  </div>
  <button class="btn btn-small" id="refreshBtn">Refresh</button>
  <div id="toolbarMsg" class="status-message"></div>
</div>

<div class="card" style="overflow:auto; max-height: calc(100vh - 170px);">
  <table id="ordersTable">
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Time</th>
        <th>Location</th>
        <th>Customer</th>
        <th>Phone</th>
        <th>Items</th>
        <th>Total (â‚¦)</th>
        <th>Notes</th>
        <th>Status</th>
        <th>Update</th>
      </tr>
    </thead>
    <tbody id="ordersBody">
      <!-- rows injected here -->
    </tbody>
  </table>
</div>

<script>
  // ðŸ”— SAME SCRIPT URL AS order.html
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykcL-56UBxebRUpFk_01x3vstSjmQ12fwPWZEvSmGEWZlDiP_pYTEMczmDKRXDGdHaXg/exec";

  const statusOptions = ["Received", "Preparing", "Completed", "Cancelled"];

  const ordersBody   = document.getElementById("ordersBody");
  const statusFilter = document.getElementById("statusFilter");
  const refreshBtn   = document.getElementById("refreshBtn");
  const lastRefresh  = document.getElementById("lastRefresh");
  const toolbarMsg   = document.getElementById("toolbarMsg");

  let allOrders = [];
  let adminPin  = "";     // we only store it in memory on the page

  // --------------------------------------------------
  // Ask for PIN and then load data
  // --------------------------------------------------
  function askForPin() {
    const entered = prompt("Enter admin PIN:");
    if (!entered) {
      document.body.innerHTML = "<p style='padding:16px;font-family:sans-serif;'>Access cancelled.</p>";
      throw new Error("PIN entry cancelled");
    }
    adminPin = entered;
  }

  // --------------------------------------------------
  // Load orders from Apps Script (GET ?mode=orders&pin=...)
  // --------------------------------------------------
  async function loadOrders() {
    try {
      if (!adminPin) askForPin();

      toolbarMsg.textContent = "Loading...";
      toolbarMsg.className = "status-message";

      const filterVal = statusFilter.value || "All";
      const url = SCRIPT_URL +
        "?mode=orders" +
        "&pin=" + encodeURIComponent(adminPin) +
        "&status=" + encodeURIComponent(filterVal);

      const resp = await fetch(url);
      const data = await resp.json();

      if (!data.success) {
        if (data.error === "Unauthorized") {
          adminPin = "";
          alert("Wrong PIN. Please try again.");
          askForPin();
          return loadOrders();
        }
        throw new Error(data.error || "Unknown error");
      }

      allOrders = data.orders || [];

      renderOrders();

      const tsStr = data.lastRefresh
        ? new Date(data.lastRefresh).toLocaleString()
        : new Date().toLocaleString();
      lastRefresh.textContent = tsStr;

      toolbarMsg.textContent = "Loaded " + allOrders.length + " orders.";
      toolbarMsg.className = "status-message ok";
    } catch (err) {
      console.error(err);
      toolbarMsg.textContent = "Error loading orders.";
      toolbarMsg.className = "status-message err";
    }
  }

  // --------------------------------------------------
  // Render table rows with dropdown + Save
  // --------------------------------------------------
  function renderOrders() {
    ordersBody.innerHTML = "";

    if (!allOrders.length) {
      const tr = document.createElement("tr");
      const td = document.createElement("td");
      td.colSpan = 10;
      td.textContent = "No orders found.";
      td.style.textAlign = "center";
      td.style.color = "#777";
      tr.appendChild(td);
      ordersBody.appendChild(tr);
      return;
    }

    allOrders.forEach(order => {
      const tr = document.createElement("tr");

      const tdOrderId = document.createElement("td");
      tdOrderId.textContent = order.orderId || "";
      tr.appendChild(tdOrderId);

      const tdTime = document.createElement("td");
      tdTime.textContent = order.time;
      tr.appendChild(tdTime);

      const tdLocation = document.createElement("td");
      tdLocation.textContent = order.location;
      tr.appendChild(tdLocation);

      const tdCustomer = document.createElement("td");
      tdCustomer.textContent = order.customerName;
      tr.appendChild(tdCustomer);

      const tdPhone = document.createElement("td");
      tdPhone.textContent = order.phone;
      tr.appendChild(tdPhone);

      const tdItems = document.createElement("td");
      tdItems.textContent = order.items;
      tr.appendChild(tdItems);

      const tdTotal = document.createElement("td");
      tdTotal.textContent = order.total;
      tr.appendChild(tdTotal);

      const tdNotes = document.createElement("td");
      tdNotes.textContent = order.notes;
      tr.appendChild(tdNotes);

      const tdStatus = document.createElement("td");
      const chip = document.createElement("span");
      const st = (order.status || "Received");
      chip.className = "chip " + st.toLowerCase();
      chip.textContent = st;
      tdStatus.appendChild(chip);
      tr.appendChild(tdStatus);

      const tdUpdate = document.createElement("td");

      const select = document.createElement("select");
      statusOptions.forEach(opt => {
        const o = document.createElement("option");
        o.value = opt;
        o.textContent = opt;
        if (st === opt) o.selected = true;
        select.appendChild(o);
      });

      const btn = document.createElement("button");
      btn.className = "btn btn-small";
      btn.textContent = "Save";

      btn.addEventListener("click", () => {
        const newStatus = select.value;
        updateStatus(order.rowIndex, newStatus, chip, order);
      });

      tdUpdate.appendChild(select);
      tdUpdate.appendChild(document.createTextNode(" "));
      tdUpdate.appendChild(btn);

      tr.appendChild(tdUpdate);

      ordersBody.appendChild(tr);
    });
  }

  // --------------------------------------------------
  // Call Apps Script to update status (POST, no-cors)
  // body: { action:"updateStatus", rowIndex, status, pin }
  // We DON'T read the JSON response to avoid parse / CORS errors.
  // --------------------------------------------------
  async function updateStatus(rowIndex, newStatus, chipEl, orderObj) {
    try {
      if (!adminPin) askForPin();

      toolbarMsg.textContent = "Saving...";
      toolbarMsg.className = "status-message";

      await fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify({
          action: "updateStatus",
          rowIndex: rowIndex,
          status: newStatus,
          pin: adminPin
        })
      });

      // Assume success and update UI / local copy
      orderObj.status = newStatus;
      chipEl.textContent = newStatus;
      chipEl.className = "chip " + newStatus.toLowerCase();

      toolbarMsg.textContent = "Status update sent (may take a moment to reflect in the sheet).";
      toolbarMsg.className = "status-message ok";
    } catch (err) {
      console.error(err);
      toolbarMsg.textContent = "Error updating status.";
      toolbarMsg.className = "status-message err";
    }
  }

  // --------------------------------------------------
  // Events
  // --------------------------------------------------
  statusFilter.addEventListener("change", loadOrders);
  refreshBtn.addEventListener("click", loadOrders);

  // --------------------------------------------------
  // Init
  // --------------------------------------------------
  (function init() {
    askForPin();
    loadOrders();
  })();
</script>

</body>
</html>
