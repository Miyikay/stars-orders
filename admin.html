<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stars Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --primary: #ff5a1f;
      --primary-dark: #e04b13;
      --bg: #f7f7f7;
      --card-bg: #ffffff;
      --border: #e0e0e0;
      --text-main: #222222;
      --text-muted: #666666;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      padding: 16px;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    h1 {
      margin: 0 0 4px 0;
      font-size: 1.4rem;
      font-weight: 600;
    }

    .subtitle {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }

    select {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      font-size: 0.85rem;
    }

    button {
      cursor: pointer;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 0.85rem;
      font-weight: 500;
      background: var(--primary);
      color: #fff;
    }

    .btn:hover {
      background: var(--primary-dark);
    }

    .table-wrapper {
      background: var(--card-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: auto;
      max-height: 75vh;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #fafafa;
      z-index: 1;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid #f0f0f0;
      text-align: left;
      vertical-align: top;
    }

    th {
      font-weight: 600;
      font-size: 0.8rem;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    tr:nth-child(even) td {
      background: #fcfcfc;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
    }

    .status-Received {
      background: #fff4e5;
      color: #b85c00;
    }

    .status-Preparing {
      background: #e6f2ff;
      color: #0052a3;
    }

    .status-Completed {
      background: #e7f8ec;
      color: #1f7a3b;
    }

    .status-Cancelled {
      background: #fde7e7;
      color: #c0392b;
    }

    .small {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .notes-cell {
      max-width: 220px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .status-select {
      padding: 4px 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      font-size: 0.8rem;
    }

    .last-refresh {
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    @media (max-width: 768px) {
      th, td {
        padding: 6px 6px;
      }
    }
  </style>
</head>
<body>

<div class="top-row">
  <div>
    <h1>Stars Orders – Admin</h1>
    <div class="subtitle">View and manage all incoming orders from your Google Sheet.</div>
  </div>
  <div class="controls">
    <label class="small">
      Filter by status:
      <select id="statusFilter">
        <option value="ALL">All</option>
        <option value="Received">Received</option>
        <option value="Preparing">Preparing</option>
        <option value="Completed">Completed</option>
        <option value="Cancelled">Cancelled</option>
      </select>
    </label>
    <button class="btn" id="refreshBtn">Refresh</button>
  </div>
</div>

<div class="last-refresh" id="lastRefresh">Last refresh: –</div>

<div class="table-wrapper">
  <table>
    <thead>
      <tr>
        <th>Order ID</th>
        <th>Time</th>
        <th>Location</th>
        <th>Customer</th>
        <th>Phone</th>
        <th>Items</th>
        <th>Total (₦)</th>
        <th>Notes</th>
        <th>Status</th>
        <th>Update</th>
      </tr>
    </thead>
    <tbody id="ordersBody">
      <!-- rows injected here -->
    </tbody>
  </table>
</div>

<script>
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbykcL-56UBxebRUpFk_01x3vstSjmQ12fwPWZEvSmGEWZlDiP_pYTEMczmDKRXDGdHaXg/exec";

  const statusFilter = document.getElementById("statusFilter");
  const refreshBtn = document.getElementById("refreshBtn");
  const ordersBody = document.getElementById("ordersBody");
  const lastRefresh = document.getElementById("lastRefresh");

  let allOrders = [];

  function formatDate(value) {
    if (!value) return "";
    try {
      const d = new Date(value);
      if (isNaN(d)) return String(value);
      return d.toLocaleString();
    } catch (e) {
      return String(value);
    }
  }

  function renderTable() {
    const filter = statusFilter.value;
    ordersBody.innerHTML = "";

    const filtered = allOrders.filter(order => {
      if (filter === "ALL") return true;
      return (order.status || "") === filter;
    });

    if (filtered.length === 0) {
      const row = document.createElement("tr");
      const cell = document.createElement("td");
      cell.colSpan = 10;
      cell.textContent = "No orders found.";
      cell.className = "small";
      row.appendChild(cell);
      ordersBody.appendChild(row);
      return;
    }

    filtered.forEach(order => {
      const tr = document.createElement("tr");

      // Order ID
      const tdId = document.createElement("td");
      tdId.textContent = order.orderId || "";
      tr.appendChild(tdId);

      // Time
      const tdTime = document.createElement("td");
      tdTime.textContent = formatDate(order.timestamp);
      tr.appendChild(tdTime);

      // Location
      const tdLoc = document.createElement("td");
      tdLoc.textContent = order.location || "";
      tr.appendChild(tdLoc);

      // Customer
      const tdCustomer = document.createElement("td");
      tdCustomer.innerHTML = `<strong>${order.customerName || ""}</strong>`;
      tr.appendChild(tdCustomer);

      // Phone
      const tdPhone = document.createElement("td");
      tdPhone.textContent = order.phone || "";
      tr.appendChild(tdPhone);

      // Items
      const tdItems = document.createElement("td");
      tdItems.textContent = order.items || "";
      tr.appendChild(tdItems);

      // Total
      const tdTotal = document.createElement("td");
      tdTotal.textContent = order.total || "";
      tr.appendChild(tdTotal);

      // Notes
      const tdNotes = document.createElement("td");
      tdNotes.className = "notes-cell";
      tdNotes.textContent = order.notes || "";
      tr.appendChild(tdNotes);

      // Status display
      const tdStatus = document.createElement("td");
      const pill = document.createElement("span");
      const status = order.status || "Received";
      pill.className = "status-pill status-" + status;
      pill.textContent = status;
      tdStatus.appendChild(pill);
      tr.appendChild(tdStatus);

      // Status update controls
      const tdUpdate = document.createElement("td");
      const select = document.createElement("select");
      select.className = "status-select";
      ["Received", "Preparing", "Completed", "Cancelled"].forEach(s => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        if (s === status) opt.selected = true;
        select.appendChild(opt);
      });

      const btn = document.createElement("button");
      btn.textContent = "Save";
      btn.className = "btn";
      btn.style.padding = "4px 10px";
      btn.style.fontSize = "0.75rem";
      btn.style.marginLeft = "4px";

      btn.addEventListener("click", async () => {
        const newStatus = select.value;
        await updateStatus(order.rowNumber, newStatus);
        order.status = newStatus;
        renderTable();
      });

      tdUpdate.appendChild(select);
      tdUpdate.appendChild(btn);
      tr.appendChild(tdUpdate);

      ordersBody.appendChild(tr);
    });
  }

  async function loadOrders() {
    try {
      ordersBody.innerHTML = "";
      const row = document.createElement("tr");
      const cell = document.createElement("td");
      cell.colSpan = 10;
      cell.textContent = "Loading orders...";
      cell.className = "small";
      row.appendChild(cell);
      ordersBody.appendChild(row);

      const resp = await fetch(SCRIPT_URL + "?mode=orders");
      const data = await resp.json();
      allOrders = data.orders || [];
      renderTable();

      const now = new Date();
      lastRefresh.textContent = "Last refresh: " + now.toLocaleString();

    } catch (err) {
      console.error(err);
      ordersBody.innerHTML = "";
      const row = document.createElement("tr");
      const cell = document.createElement("td");
      cell.colSpan = 10;
      cell.textContent = "Error loading orders. Check console.";
      cell.className = "small";
      row.appendChild(cell);
      ordersBody.appendChild(row);
    }
  }

  async function updateStatus(rowNumber, newStatus) {
    try {
      await fetch(SCRIPT_URL, {
        method: "POST",
        mode: "no-cors",
        headers: {
          "Content-Type": "text/plain;charset=utf-8"
        },
        body: JSON.stringify({
          action: "updateStatus",
          rowNumber: rowNumber,
          status: newStatus
        })
      });
    } catch (err) {
      console.error("Failed to update status", err);
    }
  }

  statusFilter.addEventListener("change", renderTable);
  refreshBtn.addEventListener("click", loadOrders);

  // Initial load
  loadOrders();
</script>

</body>
</html>
